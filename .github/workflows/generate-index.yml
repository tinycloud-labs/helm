name: Publish Helm Charts

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'
      - '.github/chart-index-template.md'
      - '.github/workflows/publish.yaml'

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v3

      - name: Install yq
        run: |
          sudo add-apt-repository ppa:rmescandon/yq -y
          sudo apt update
          sudo apt install yq -y

      - name: Package charts
        run: |
          mkdir -p .deploy
          for chart in charts/*; do
            if [[ -f "$chart/Chart.yaml" ]]; then
              helm package "$chart" -d .deploy
            fi
          done

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Update index.yaml
        run: |
          cd gh-pages

          mkdir -p .
          if [[ ! -f index.yaml ]]; then
            echo "Creating new index.yaml"
            helm repo index . --url https://tinycloud-labs.github.io/helm
          else
            echo "Merging charts into existing index.yaml"
            helm repo index ../.deploy --merge index.yaml --url https://tinycloud-labs.github.io/helm
          fi

          # Move new package files into gh-pages
          cp ../.deploy/*.tgz .

      - name: Parse index.yaml for chart metadata
        id: charts
        run: |
          cd gh-pages
          charts=$(yq -o json '.entries | to_entries |
            map({
              name: .key,
              version: .value[0].version,
              description: .value[0].description
            })' index.yaml)

          echo "charts<<EOF" >> $GITHUB_OUTPUT
          echo "$charts" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate markdown table
        id: table
        run: |
          echo "table<<EOF" >> $GITHUB_OUTPUT

          echo '| Chart | Version | Description |'
          echo '|-------|---------|-------------|'

          echo '${{ steps.charts.outputs.charts }}' | jq -c '.[]' |
          while read -r chart; do
            name=$(echo "$chart" | jq -r '.name')
            version=$(echo "$chart" | jq -r '.version')
            description=$(echo "$chart" | jq -r '.description')

            echo "| [$name](https://github.com/tinycloud-labs/helm/tree/main/charts/$name) | $version | $description |"
          done

          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build index.md from template
        run: |
          cd gh-pages

          awk '
            /<!--CHART_TABLE-->/ { print; exit }
            { print }
          ' ../.github/chart-index-template.md > index.md

          printf "%s\n" "${{ steps.table.outputs.table }}" >> index.md

          awk 'found { print } /<!--CHART_TABLE-->/ { found=1 }' \
            ../.github/chart-index-template.md >> index.md

      - name: Commit & Push
        run: |
          cd gh-pages
          git config user.email "github-actions@github.com"
          git config user.name "github-actions"
          git add .
          git commit -m "Update charts and index" || echo "No changes"
          git push
